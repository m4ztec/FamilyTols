@page "/inventory/edit/{id}"
@using HomeInventory.shared.Models
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inject HttpClient http
@inject NavigationManager Navigation
@inject IJSRuntime jsRuntime
@attribute [Authorize]

@if (inv is null)
{
    <p role="alert">Sorry, there's nothing at this address.</p>
}
else
{
    <h3>Edit</h3>

    <div class="mb-3">
        <label>Name:</label>
        <InputText @bind-Value="inv.Name" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Descrition</label>
        <InputText @bind-Value="inv.Description" class="form-control" />
    </div>

    <div class="mb-3 d-flex gap-2">
        <button type="submit" class="btn btn-primary" @onclick="EditInventory">Save</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
        <button type="button" class="btn btn-danger" @onclick="DeleteInventory">Delete Inventory</button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
}

@code {

    [Parameter]
    public required string id { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    Inventory? inv;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        inv = await http.GetFromJsonAsync<Inventory>($"/api/Inventory/{id}");
    }

    private async Task EditInventory()
    {
        if (inv is null)
            return;

        var editedResponse = await http.PutAsJsonAsync("/api/Inventory/", inv);
        if (editedResponse.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/inventory");
        }
        else
        {
            errorMessage = "Failed to save inventory changes.";
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/inventory");
    }

    private async Task DeleteInventory()
    {
        if (inv is null)
            return;

        var confirmed = await jsRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{inv.Name}'? This action cannot be undone.");
        if (!confirmed)
            return;

        var deleteResponse = await http.DeleteAsync($"/api/Inventory/{inv.Id}");
        if (deleteResponse.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/inventory");
        }
        else
        {
            errorMessage = "Failed to delete inventory.";
        }
    }
}
