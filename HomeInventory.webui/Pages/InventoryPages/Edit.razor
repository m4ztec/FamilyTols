@page "/inventory/edit/{id}"
@using HomeInventory.shared.Models
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient http
@inject NavigationManager Navigation
@inject IJSRuntime jsRuntime
@inject AuthenticationStateProvider authStateProvider
@attribute [Authorize]

@if (inv is null)
{
    <p role="alert">Sorry, there's nothing at this address.</p>
}
else
{
    <h3>Edit</h3>

    <div class="mb-3">
        <label>Name:</label>
        <InputText @bind-Value="inv.Name" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Descrition</label>
        <InputText @bind-Value="inv.Description" class="form-control" />
    </div>

    <!-- Collapsible Members Section -->
    <div class="mb-3 card">
        <div class="card-header" role="button" @onclick="ToggleMembersCollapse" style="cursor: pointer;">
            <div class="d-flex justify-content-between align-items-center">
                <span>
                    @if (showMembers)
                    {
                        <span>▼</span>
                    }
                    else
                    {
                        <span>▶</span>
                    }
                    Members @(members?.Count ?? 0)
                </span>
                <div class="d-flex gap-2">
                    @if (IsCurrentUserOwner)
                    {
                        <button type="button" class="btn btn-sm btn-primary" @onclick:stopPropagation="true" @onclick="OpenAddMemberDialog">
                            Add Member
                        </button>
                    }
                </div>
            </div>
        </div>
        @if (showMembers && members != null)
        {
            <div class="card-body">
                @if (members.Count == 0)
                {
                    <p class="text-muted">No members yet.</p>
                }
                else
                {
                    <div class="list-group">
                        @foreach (var member in members)
                        {
                            var memberName = userNames.TryGetValue(member.UserId, out var name) ? name : member.UserId;
                            var isOwner = inv is not null && string.Equals(inv.Owner, member.UserId, StringComparison.OrdinalIgnoreCase);
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    @if (isOwner)
                                    {
                                        <span title="Owner" class="me-2">👑</span>
                                    }
                                    <span>@memberName</span>
                                </div>
                                @if (!isOwner && IsCurrentUserOwner)
                                {
                                    <button type="button" class="btn btn-sm btn-danger" @onclick="() => RemoveMember(member.UserId)">
                                        Remove
                                    </button>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>

    <div class="mb-3 d-flex gap-2">
        <button type="submit" class="btn btn-primary" @onclick="EditInventory">Save</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
        @if (IsCurrentUserOwner)
        {
            <button type="button" class="btn btn-danger" @onclick="DeleteInventory">Delete Inventory</button>
        }
        else
        {
            <button type="button" class="btn btn-outline-danger" @onclick="LeaveInventory">Leave Inventory</button>
        }
    </div>

    <div class="mb-3">
        @if (IsCurrentUserOwner)
        {
            <button type="button" class="btn btn-outline-secondary" @onclick="OpenTransferOwnerDialog">
                Transfer Owner
            </button>
        }
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
}

<dialog @ref="addMemberDialog">
    <h4>Add Member</h4>
    <div class="mb-3">
        <label>Select User:</label>
        @if (availableUsers == null)
        {
            <p class="text-muted">Loading users...</p>
        }
        else if (availableUsers.Count == 0)
        {
            <p class="text-muted">No available users to add.</p>
        }
        else
        {
            <input type="text" @bind="searchUserInput" @bind:event="oninput" placeholder="Search by name..." class="form-control mb-2" />
            <div class="list-group" style="max-height: 300px; overflow-y: auto;">
                @foreach (var user in FilteredAvailableUsers())
                {
                    <button type="button" class="list-group-item list-group-item-action" @onclick="() => SelectUser(user)">
                        @user.DisplayName
                        <small class="d-block text-muted">@user.UserId</small>
                    </button>
                }
            </div>
        }
    </div>

    @if (!string.IsNullOrEmpty(selectedUserName))
    {
        <div class="mb-3 p-2 bg-light border rounded">
            <p class="mb-0">Selected: <strong>@selectedUserName</strong></p>
        </div>
    }

    @if (!string.IsNullOrEmpty(memberErrorMessage))
    {
        <div class="alert alert-danger mb-2">@memberErrorMessage</div>
    }

    <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" @onclick="ConfirmAddMember" disabled="@string.IsNullOrEmpty(selectedUserId)">Add</button>
        <button type="button" class="btn btn-secondary" @onclick="CloseAddMemberDialog">Cancel</button>
    </div>
</dialog>

<dialog @ref="transferOwnerDialog">
    <h4>Transfer Ownership</h4>
    <div class="mb-3">
        <label>Select new owner:</label>
        @if (availableUsers == null)
        {
            <p class="text-muted">Loading users...</p>
        }
        else
        {
            <input type="text" @bind="transferSearchInput" @bind:event="oninput" placeholder="Search by name..." class="form-control mb-2" />
            <div class="list-group" style="max-height:300px; overflow-y:auto;">
                @foreach (var user in FilteredTransferCandidates())
                {
                    <button type="button" class="list-group-item list-group-item-action" @onclick="() => SelectTransferCandidate(user)">
                        @user.DisplayName
                        <small class="d-block text-muted">@user.UserId</small>
                    </button>
                }
            </div>
        }
    </div>

    @if (!string.IsNullOrEmpty(selectedTransferUserName))
    {
        <div class="mb-3 p-2 bg-light border rounded">
            <p class="mb-0">Selected: <strong>@selectedTransferUserName</strong></p>
        </div>
    }

    @if (!string.IsNullOrEmpty(memberErrorMessage))
    {
        <div class="alert alert-danger mb-2">@memberErrorMessage</div>
    }

    <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" @onclick="ConfirmTransferOwner" disabled="@string.IsNullOrEmpty(selectedTransferUserId)">Transfer</button>
        <button type="button" class="btn btn-secondary" @onclick="CloseTransferOwnerDialog">Cancel</button>
    </div>
</dialog>

@code {

    [Parameter]
    public required string id { get; set; }
    
    Inventory? inv;
    private string errorMessage = string.Empty;
    private string memberErrorMessage = string.Empty;
    private bool showMembers = false;
    private List<InventoryMembers> members = new();
    private ElementReference addMemberDialog;
    
    private List<UserProfile>? availableUsers;
    private string searchUserInput = string.Empty;
    private string selectedUserId = string.Empty;
    private string selectedUserName = string.Empty;
    private Dictionary<string, string> userNames = new(); // Maps UserId -> DisplayName
    private ElementReference transferOwnerDialog;
    private string transferSearchInput = string.Empty;
    private string selectedTransferUserId = string.Empty;
    private string selectedTransferUserName = string.Empty;
    
    private string currentUserId = string.Empty; // Track authenticated user's sub claim
    private bool IsCurrentUserOwner => inv is not null && !string.IsNullOrEmpty(currentUserId) 
        && string.Equals(inv.Owner, currentUserId, StringComparison.OrdinalIgnoreCase);

    private class UserProfile
    {
        public string? UserId { get; set; }
        public string? DisplayName { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // Get the current authenticated user's sub claim
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        currentUserId = user?.FindFirst("sub")?.Value ?? string.Empty;
        
        inv = await http.GetFromJsonAsync<Inventory>($"/api/Inventory/{id}");
        await LoadMembers();
        await LoadAllUsers();
    }

    private async Task LoadMembers()
    {
        try
        {
            members = (await http.GetFromJsonAsync<List<InventoryMembers>>($"/api/inventory/{id}/members")) ?? new();
        }
        catch
        {
            members = new();
        }
    }

    private async Task LoadAllUsers()
    {
        try
        {
            availableUsers = (await http.GetFromJsonAsync<List<UserProfile>>("/api/users")) ?? new();
            
            // Build user name map for quick lookup
            userNames.Clear();
            if (availableUsers != null)
            {
                foreach (var user in availableUsers)
                {
                    if (!string.IsNullOrEmpty(user.UserId))
                    {
                        userNames[user.UserId] = user.DisplayName ?? user.UserId;
                    }
                }
            }
        }
        catch
        {
            availableUsers = new();
        }
    }

    private List<UserProfile> FilteredAvailableUsers()
    {
        if (availableUsers == null)
            return new();

        var existingMemberIds = new HashSet<string>(members.Select(m => m.UserId));
        var searchLower = searchUserInput.ToLower();

        return availableUsers
            .Where(u => !existingMemberIds.Contains(u.UserId ?? ""))
            .Where(u => string.IsNullOrEmpty(searchUserInput) || 
                   (u.DisplayName?.ToLower().Contains(searchLower) ?? false) ||
                   (u.UserId?.ToLower().Contains(searchLower) ?? false))
            .ToList();
    }

    private void SelectUser(UserProfile user)
    {
        selectedUserId = user.UserId ?? string.Empty;
        selectedUserName = user.DisplayName ?? user.UserId ?? string.Empty;
    }

    private async Task EditInventory()
    {
        if (inv is null)
            return;

        var editedResponse = await http.PutAsJsonAsync("/api/Inventory/", inv);
        if (editedResponse.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/inventory");
        }
        else
        {
            errorMessage = "Failed to save inventory changes.";
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/inventory");
    }

    private async Task DeleteInventory()
    {
        if (inv is null)
            return;

        var confirmed = await jsRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{inv.Name}'? This action cannot be undone.");
        if (!confirmed)
            return;

        var deleteResponse = await http.DeleteAsync($"/api/Inventory/{inv.Id}");
        if (deleteResponse.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/inventory");
        }
        else
        {
            errorMessage = "Failed to delete inventory.";
        }
    }

    private void ToggleMembersCollapse()
    {
        showMembers = !showMembers;
    }

    private async Task OpenAddMemberDialog()
    {
        searchUserInput = string.Empty;
        selectedUserId = string.Empty;
        selectedUserName = string.Empty;
        memberErrorMessage = string.Empty;
        await jsRuntime.InvokeVoidAsync("openDialog", addMemberDialog);
    }

    private async Task OpenTransferOwnerDialog()
    {
        transferSearchInput = string.Empty;
        selectedTransferUserId = string.Empty;
        selectedTransferUserName = string.Empty;
        memberErrorMessage = string.Empty;
        await jsRuntime.InvokeVoidAsync("openDialog", transferOwnerDialog);
    }

    private async Task CloseTransferOwnerDialog()
    {
        await jsRuntime.InvokeVoidAsync("closeDialog", transferOwnerDialog);
    }

    private List<UserProfile> FilteredTransferCandidates()
    {
        if (availableUsers == null)
            return new();

        var searchLower = transferSearchInput.ToLower();
        var currentOwner = inv?.Owner ?? string.Empty;

        return availableUsers
            .Where(u => !string.Equals(u.UserId, currentOwner, StringComparison.OrdinalIgnoreCase))
            .Where(u => string.IsNullOrEmpty(transferSearchInput) ||
                   (u.DisplayName?.ToLower().Contains(searchLower) ?? false) ||
                   (u.UserId?.ToLower().Contains(searchLower) ?? false))
            .ToList();
    }

    private void SelectTransferCandidate(UserProfile user)
    {
        selectedTransferUserId = user.UserId ?? string.Empty;
        selectedTransferUserName = user.DisplayName ?? user.UserId ?? string.Empty;
    }

    private async Task CloseAddMemberDialog()
    {
        await jsRuntime.InvokeVoidAsync("closeDialog", addMemberDialog);
    }

    private async Task ConfirmAddMember()
    {
        if (string.IsNullOrWhiteSpace(selectedUserId) || inv is null)
        {
            memberErrorMessage = "Please select a user.";
            return;
        }

        try
        {
            var response = await http.PostAsJsonAsync($"/api/inventory/{inv.Id}/members", new { userId = selectedUserId });
            if (response.IsSuccessStatusCode)
            {
                await LoadMembers();
                await CloseAddMemberDialog();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                memberErrorMessage = $"Failed to add member: {error}";
            }
        }
        catch (Exception ex)
        {
            memberErrorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task ConfirmTransferOwner()
    {
        if (string.IsNullOrWhiteSpace(selectedTransferUserId) || inv is null)
        {
            memberErrorMessage = "Please select a user.";
            return;
        }

        try
        {
            var resp = await http.PutAsJsonAsync($"/api/inventory/{inv.Id}/owner", new { userId = selectedTransferUserId });
            if (resp.IsSuccessStatusCode)
            {
                // refresh inventory and members
                inv = await http.GetFromJsonAsync<Inventory>($"/api/Inventory/{id}");
                await LoadMembers();
                await LoadAllUsers();
                await CloseTransferOwnerDialog();
            }
            else
            {
                var txt = await resp.Content.ReadAsStringAsync();
                memberErrorMessage = $"Transfer failed: {resp.StatusCode} - {txt}";
            }
        }
        catch (Exception ex)
        {
            memberErrorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task RemoveMember(string userId)
    {
        if (inv is null)
            return;

        var memberName = userNames.TryGetValue(userId, out var name) ? name : userId;
        var confirmed = await jsRuntime.InvokeAsync<bool>("confirm", $"Remove '{memberName}' from this inventory?");
        if (!confirmed)
            return;

        try
        {
            var response = await http.DeleteAsync($"/api/inventory/{inv.Id}/members/{userId}");
            if (response.IsSuccessStatusCode)
            {
                await LoadMembers();
            }
            else
            {
                errorMessage = "Failed to remove member.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task LeaveInventory()
    {
        if (inv is null || string.IsNullOrEmpty(currentUserId))
            return;

        var confirmed = await jsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to leave this inventory?");
        if (!confirmed)
            return;

        try
        {
            var response = await http.DeleteAsync($"/api/inventory/{inv.Id}/members/{currentUserId}");
            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/inventory");
            }
            else
            {
                errorMessage = "Failed to leave inventory.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }
}
