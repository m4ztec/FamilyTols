@page "/inventory/{inventoryId}/products"
@using Microsoft.AspNetCore.Components.QuickGrid
@using HomeInventory.shared.Models
@using System.Text.Json

@inject HttpClient http
@inject JsUtills JsUtills
@inject IJSRuntime jsRuntime
@inject NavigationManager Navigation
@attribute [Authorize]

<h3>Porducts</h3>
<div class="mb-3 d-flex gap-2 align-items-start">
    <button class="btn btn-primary" @onclick="AddNewRow">Add product</button>
    
    <button class="btn btn-danger" @onclick="OpenBulkRemoveConfirm" disabled="@(selectedProductIds.Count == 0 || isRemoving)">
        @if (isRemoving)
        {
            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
        }
        Remove selected products (@selectedProductIds.Count)
    </button>

    <a href="@($"/inventory/{inventoryId}/shopping-list")" class="btn btn-info">
        View Shopping List
    </a>

    <button class="btn btn-secondary" @onclick="BackToInventory">
        Back to Inventory
    </button>
</div>

<QuickGrid Class="table" Items="products">
    <TemplateColumn Title="" Context="context">
        <HeaderTemplate>
            <input type="checkbox" class="form-check-input" @onchange="ToggleSelectAllHeader" checked="@IsAllSelected" />
        </HeaderTemplate>
        <ChildContent Context="context">
            <input type="checkbox" @onchange="(e) => ToggleSelection(e, context)" checked="@selectedProductIds.Contains(context.ProductId)" />
        </ChildContent>
    </TemplateColumn>
    <PropertyColumn Property="product => product.ProductName" />
    <TemplateColumn Title="Price" Context="product">
        @($"{product.ProductPrice:0.00} €")
    </TemplateColumn>
    <PropertyColumn Property="product => product.ExistingAmount" />
    <PropertyColumn Property="product => product.DesiredAmount" />

    <TemplateColumn Title="Actions">
        <button class="btn btn-sm btn-primary" @onclick="() => EditInventoryProduct(context)">Edit</button>
        <button class="btn btn-sm btn-danger ms-2" @onclick="() => RemoveInventoryProduct(context)">Remove</button>
    </TemplateColumn>
</QuickGrid>


<dialog @ref="productDialog">
    <h4>@(isNewProduct ? "Add product to inventory" : "Edit inventory product")</h4>

    @if (selectedProduct is not null)
    {
        <div class="mb-3">
            <label>Product:</label>
            @if (isNewProduct)
            {
                <div class="d-flex gap-2">
                    <select class="form-select" @onchange="OnProductSelected">
                        <option value="">-- select product --</option>
                        @if (availableProducts is not null)
                        {
                            @foreach (var p in availableProducts)
                            {
                                <option value="@p.Name">@p.Name (@p.SupposedPrice.ToString()€)</option>
                            }
                        }
                    </select>
                    <button class="btn btn-outline-secondary" @onclick="OpenCreateProductDialog">Create new product</button>
                </div>
            }
            else
            {
                <input class="form-control" value="@selectedProduct.ProductName" disabled />
            }
        </div>

        <div class="mb-3">
            <label>Existing amount:</label>
            <input type="number" min="0" @bind="selectedProduct.ExistingAmount" class="form-control" />
        </div>
        <div class="mb-3">
            <label>Desired amount:</label>
            <input type="number" min="0" @bind="selectedProduct.DesiredAmount" class="form-control" />
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        <button class="btn btn-success me-2" @onclick="SaveEdit">Save</button>
        <button class="btn btn-secondary" @onclick="CloseDialog">Cancel</button>
    }
</dialog>

<dialog @ref="newProductDialog">
    <h4>Create product</h4>

    <div class="mb-3">
        <label>Name:</label>
        <input @bind="newProduct.Name" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Description:</label>
        <textarea @bind="newProduct.Description" class="form-control"></textarea>
    </div>

    <div class="mb-3">
        <label>Price:</label>
        <input type="number" step="0.01" min="0" @bind="newProduct.SupposedPrice" class="form-control" />
    </div>

    <div class="d-flex">
        <button class="btn btn-success me-2" @onclick="SaveNewProduct">Create</button>
        <button class="btn btn-secondary" @onclick="CloseNewProductDialog">Cancel</button>
    </div>
</dialog>

<dialog @ref="bulkConfirmDialog">
    <h4>Confirm removal</h4>
    <div class="mb-3">Are you sure you want to remove <strong>@selectedProductIds.Count</strong> selected product(s) from this inventory?</div>
    @if (!string.IsNullOrEmpty(bulkErrorMessage))
    {
        <div class="alert alert-danger">@bulkErrorMessage</div>
    }
    @if (!string.IsNullOrEmpty(bulkSuccessMessage))
    {
        <div class="alert alert-success">@bulkSuccessMessage</div>
    }
    <div class="d-flex">
        <button class="btn btn-danger me-2" @onclick="ConfirmBulkRemove">Remove</button>
        <button class="btn btn-secondary" @onclick="() => JsUtills.CloseDialog(bulkConfirmDialog)">Cancel</button>
    </div>
</dialog>

@code {
    [Parameter]
    public required string inventoryId { get; set; }

    private ElementReference productDialog;
    private ElementReference newProductDialog;

    public IQueryable<InventoryProductDto>? products;

    public InventoryProductDto? selectedProduct;

    private List<Product>? availableProducts;
    private bool isNewProduct = false;
    private string errorMessage = string.Empty;
    private Product newProduct = new Product { Id = Guid.NewGuid(), Name = string.Empty, Description = string.Empty, SupposedPrice = 0 };
    private HashSet<Guid> selectedProductIds = new();
    private bool isRemoving = false;
    private ElementReference bulkConfirmDialog;
    private string bulkErrorMessage = string.Empty;
    private string bulkSuccessMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await GetPorducts();
        await LoadAvailableProducts();
    }

    public async Task GetPorducts()
    {
        products = (await http.GetFromJsonAsync<IEnumerable<InventoryProductDto>>($"/api/Inventory/{inventoryId}/Products"))?.AsQueryable();
    }

    private async Task AddNewRow()
    {
        selectedProduct = new InventoryProductDto();
        isNewProduct = true;
        errorMessage = string.Empty;
        await JsUtills.OpenDialog(productDialog);
    }

    private async Task EditInventoryProduct(InventoryProductDto product)
    {
        // copy the product so edits don't modify the list directly
        selectedProduct = new InventoryProductDto
        {
            ProductId = product.ProductId,
            ProductName = product.ProductName,
            ProductPrice = product.ProductPrice,
            ExistingAmount = product.ExistingAmount,
            DesiredAmount = product.DesiredAmount
        };
        isNewProduct = false;
        errorMessage = string.Empty;
        await JsUtills.OpenDialog(productDialog);
    }

    private async Task SaveEdit()
    {
        if (selectedProduct is null)
            return;

        if (isNewProduct)
        {
            // basic validation
            if (string.IsNullOrWhiteSpace(selectedProduct.ProductName))
            {
                errorMessage = "Please select a product.";
                return;
            }

            var response = await http.PostAsJsonAsync($"/api/Inventory/{inventoryId}/products", selectedProduct);

            if (response.IsSuccessStatusCode)
            {
                // refresh
                await GetPorducts();
                selectedProduct = null;
                isNewProduct = false;
                await JsUtills.CloseDialog(productDialog);
            }
            else
            {
                var text = await response.Content.ReadAsStringAsync();
                errorMessage = $"Error: {response.StatusCode} - {text}";
            }
        }
        else
        {
            // editing inventory product - call the PUT endpoint
            var response = await http.PutAsJsonAsync(
                $"/api/Inventory/{inventoryId}/products/{selectedProduct.ProductId}", 
                selectedProduct);

            if (response.IsSuccessStatusCode)
            {
                // refresh
                await GetPorducts();
                selectedProduct = null;
                await JsUtills.CloseDialog(productDialog);
            }
            else
            {
                var text = await response.Content.ReadAsStringAsync();
                errorMessage = $"Error: {response.StatusCode} - {text}";
            }
        }
    }

    private async Task CloseDialog()
    {
        await JsUtills.CloseDialog(productDialog);
    }

    private async Task LoadAvailableProducts()
    {
        try
        {
            availableProducts = (await http.GetFromJsonAsync<IEnumerable<Product>>("/api/Product/"))?.ToList();
        }
        catch
        {
            availableProducts = new List<Product>();
        }
    }

    private void ToggleSelection(ChangeEventArgs e, InventoryProductDto product)
    {
        var isChecked = false;
        if (e.Value is bool b)
            isChecked = b;
        else if (e.Value is string s && bool.TryParse(s, out var parsed))
            isChecked = parsed;

        if (isChecked)
            selectedProductIds.Add(product.ProductId);
        else
            selectedProductIds.Remove(product.ProductId);
    }

    // Removed per-item sequential bulk delete in favor of bulk endpoint usage via ConfirmBulkRemove

    private bool IsAllSelected => products is not null && selectedProductIds.Count > 0 && products.Count() == selectedProductIds.Count;

    private void ToggleSelectAllHeader(ChangeEventArgs e)
    {
        var isChecked = false;
        if (e.Value is bool b)
            isChecked = b;
        else if (e.Value is string s && bool.TryParse(s, out var parsed))
            isChecked = parsed;

        if (isChecked)
        {
            selectedProductIds.Clear();
            if (products is not null)
            {
                foreach (var p in products)
                    selectedProductIds.Add(p.ProductId);
            }
        }
        else
        {
            selectedProductIds.Clear();
        }
    }

    private async Task OpenBulkRemoveConfirm()
    {
        bulkErrorMessage = string.Empty;
        bulkSuccessMessage = string.Empty;
        await JsUtills.OpenDialog(bulkConfirmDialog);
    }

    private async Task ConfirmBulkRemove()
    {
        await JsUtills.CloseDialog(bulkConfirmDialog);
        if (selectedProductIds.Count == 0)
            return;

        isRemoving = true;
        try
        {
            var ids = selectedProductIds.ToArray();
            var resp = await http.PostAsJsonAsync($"/api/inventory/{inventoryId}/products/bulk-delete", ids);
            if (resp.IsSuccessStatusCode)
            {
                var result = await resp.Content.ReadFromJsonAsync<JsonElement?>();
                bulkSuccessMessage = "Removed " + (result?.GetProperty("deletedCount").GetInt32().ToString() ?? "items") + " products.";
                await GetPorducts();
                selectedProductIds.Clear();
            }
            else
            {
                var txt = await resp.Content.ReadAsStringAsync();
                bulkErrorMessage = $"Bulk remove failed: {resp.StatusCode} - {txt}";
            }
        }
        finally
        {
            isRemoving = false;
        }
    }

    private async Task OnProductSelected(ChangeEventArgs e)
    {
        var name = e.Value?.ToString() ?? string.Empty;
        if (string.IsNullOrEmpty(name) || selectedProduct is null)
            return;

        selectedProduct.ProductName = name;
        var p = availableProducts?.FirstOrDefault(x => x.Name == name);
        if (p is not null)
            selectedProduct.ProductPrice = p.SupposedPrice;

        await Task.CompletedTask;
    }

    private async Task OpenCreateProductDialog()
    {
        // initialize new product with new id to match server expectations
        newProduct = new Product { Id = Guid.NewGuid(), Name = string.Empty, Description = string.Empty, SupposedPrice = 0 };
        await JsUtills.OpenDialog(newProductDialog);
    }

    private async Task SaveNewProduct()
    {
        if (string.IsNullOrWhiteSpace(newProduct?.Name))
        {
            // simple client validation
            return;
        }

        var resp = await http.PostAsJsonAsync("/api/Product/", newProduct);
        if (resp.IsSuccessStatusCode)
        {
            // refresh available products and select the created one
            await LoadAvailableProducts();

            if (selectedProduct is not null)
            {
                selectedProduct.ProductName = newProduct.Name;
                selectedProduct.ProductPrice = newProduct.SupposedPrice;
            }

            await JsUtills.CloseDialog(newProductDialog);
        }
        else
        {
            // optionally surface error - keep simple
            var txt = await resp.Content.ReadAsStringAsync();
            errorMessage = $"Create product failed: {resp.StatusCode} - {txt}";
        }
    }

    private async Task CloseNewProductDialog()
    {
        await JsUtills.CloseDialog(newProductDialog);
    }

    private async Task RemoveInventoryProduct(InventoryProductDto product)
    {
        if (product is null)
            return;

        var confirmed = await jsRuntime.InvokeAsync<bool>("confirm", $"Remove '{product.ProductName}' from this inventory?");
        if (!confirmed)
            return;

        isRemoving = true;
        try
        {
            var ids = new Guid[] { product.ProductId };
            var resp = await http.PostAsJsonAsync($"/api/inventory/{inventoryId}/products/bulk-delete", ids);
            if (resp.IsSuccessStatusCode)
            {
                await GetPorducts();
            }
            else
            {
                var txt = await resp.Content.ReadAsStringAsync();
                errorMessage = $"Remove failed: {resp.StatusCode} - {txt}";
            }
        }
        finally
        {
            isRemoving = false;
        }
    }

    private void BackToInventory()
    {
        Navigation.NavigateTo("/inventory");
    }
}
