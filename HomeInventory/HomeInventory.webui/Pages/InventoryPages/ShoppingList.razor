@page "/inventory/{inventoryId}/shopping-list"
@using Microsoft.AspNetCore.Components.QuickGrid
@using HomeInventory.shared.Models
@inject HttpClient http
@inject NavigationManager Navigation
@attribute [Authorize]

<div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
        <button class="btn btn-secondary btn-sm" @onclick="BackToProducts">Back to Products</button>
        <h3 class="mb-0">Shopping List</h3>
    </div>

    <div class="mb-3 d-flex gap-2 align-items-start justify-content-end">
        <button class="btn btn-success" @onclick="BuySelected" disabled="@(selectedProductIds.Count == 0 || isBuying)">
            @if (isBuying)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            }
            Buy Selected (@selectedProductIds.Count)
        </button>
    </div>
</div>

@if (isLoading)
{
    <div class="d-flex justify-content-center align-items-center" style="height:60vh">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading products...</div>
        </div>
    </div>
}
else if (products?.Any() != true)
{
    <div class="alert alert-info">
        All products have sufficient stock! No items needed for shopping.
    </div>
}
else
{
    <QuickGrid Class="table" Items="products">
        <TemplateColumn Title="" Context="context">
            <HeaderTemplate>
                <input type="checkbox" class="form-check-input" @onchange="ToggleSelectAllHeader" checked="@IsAllSelected" />
            </HeaderTemplate>
            <ChildContent Context="context">
                <input type="checkbox" @onchange="(e) => ToggleSelection(e, context)" checked="@selectedProductIds.Contains(context.ProductId)" />
            </ChildContent>
        </TemplateColumn>
        <PropertyColumn Property="product => product.ProductName" Title="Product" />
        <TemplateColumn Title="Price" Context="product">
            @($"{product.ProductPrice:0.00} €")
        </TemplateColumn>
        <PropertyColumn Property="product => product.ExistingAmount" Title="Current Stock" />
        <PropertyColumn Property="product => product.DesiredAmount" Title="Desired Stock" />
        <TemplateColumn Title="Need to Buy" Context="product">
            @(product.DesiredAmount - product.ExistingAmount)
        </TemplateColumn>
        <TemplateColumn Title="Total Cost" Context="product">
            @($"{(product.DesiredAmount - product.ExistingAmount) * product.ProductPrice:0.00} €")
        </TemplateColumn>
        <TemplateColumn Title="Actions" Context="product">
            <button class="btn btn-sm btn-success" @onclick="() => BuyProduct(product)">Bought</button>
        </TemplateColumn>
    </QuickGrid>

    <div class="mt-3">
        <strong>Total Shopping Cost: </strong>
        @{
            var totalCost = products.Sum(p => (p.DesiredAmount - p.ExistingAmount) * p.ProductPrice);
        }
        @($"{totalCost:0.00} €")
    </div>
}

@code {
    [Parameter]
    public required string inventoryId { get; set; }

    private IQueryable<InventoryProductDto>? products;
    private bool isLoading = true;
    private bool isBuying = false;
    private HashSet<Guid> selectedProductIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        isLoading = true;
        try
        {
            // Get all products for the inventory
            var allProducts = await http.GetFromJsonAsync<IEnumerable<InventoryProductDto>>($"/api/Inventory/{inventoryId}/Products");
            
            // Filter locally to show only products where desired > existing
            products = allProducts?
                .Where(p => p.DesiredAmount > p.ExistingAmount)
                .OrderByDescending(p => p.DesiredAmount - p.ExistingAmount)
                .AsQueryable();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleSelection(ChangeEventArgs e, InventoryProductDto product)
    {
        var isChecked = false;
        if (e.Value is bool b)
            isChecked = b;
        else if (e.Value is string s && bool.TryParse(s, out var parsed))
            isChecked = parsed;

        if (isChecked)
            selectedProductIds.Add(product.ProductId);
        else
            selectedProductIds.Remove(product.ProductId);
    }

    private bool IsAllSelected => products is not null && selectedProductIds.Count > 0 && products.Count() == selectedProductIds.Count;

    private void ToggleSelectAllHeader(ChangeEventArgs e)
    {
        var isChecked = false;
        if (e.Value is bool b)
            isChecked = b;
        else if (e.Value is string s && bool.TryParse(s, out var parsed))
            isChecked = parsed;

        if (isChecked)
        {
            selectedProductIds.Clear();
            if (products is not null)
            {
                foreach (var p in products)
                    selectedProductIds.Add(p.ProductId);
            }
        }
        else
        {
            selectedProductIds.Clear();
        }
    }

    private async Task BuyProduct(InventoryProductDto product)
    {
        isBuying = true;
        try
        {
            var updated = new InventoryProductDto
            {
                ProductId = product.ProductId,
                ProductName = product.ProductName,
                ProductPrice = product.ProductPrice,
                ExistingAmount = product.DesiredAmount,
                DesiredAmount = product.DesiredAmount
            };
            var resp = await http.PutAsJsonAsync($"/api/Inventory/{inventoryId}/products/{product.ProductId}", updated);
            if (resp.IsSuccessStatusCode)
            {
                await LoadProducts();
                selectedProductIds.Remove(product.ProductId);
            }
        }
        finally
        {
            isBuying = false;
        }
    }

    private async Task BuySelected()
    {
        if (products is null || selectedProductIds.Count == 0)
            return;
        isBuying = true;
        try
        {
            var toBuy = products.Where(p => selectedProductIds.Contains(p.ProductId)).ToList();
            foreach (var product in toBuy)
            {
                var updated = new InventoryProductDto
                {
                    ProductId = product.ProductId,
                    ProductName = product.ProductName,
                    ProductPrice = product.ProductPrice,
                    ExistingAmount = product.DesiredAmount,
                    DesiredAmount = product.DesiredAmount
                };
                await http.PutAsJsonAsync($"/api/Inventory/{inventoryId}/products/{product.ProductId}", updated);
            }
            await LoadProducts();
            selectedProductIds.Clear();
        }
        finally
        {
            isBuying = false;
        }
    }

    private void BackToProducts()
    {
        Navigation.NavigateTo($"/inventory/{inventoryId}/products");
    }
}
