@page "/inventory/{inventoryId}/shopping-list"
@using Microsoft.AspNetCore.Components.QuickGrid
@using HomeInventory.shared.Models
@inject HttpClient http
@inject NavigationManager Navigation
@inject IJSRuntime jsRuntime
@attribute [Authorize]

<div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-2">
        <button class="btn btn-secondary btn-sm" @onclick="BackToProducts">Back to Products</button>
        <h3 class="mb-0">Shopping List</h3>
    </div>
    <div class="mb-3 d-flex gap-2 align-items-start justify-content-end">
        <button class="btn btn-success" @onclick="BuySelected" disabled="@(selectedProductIds.Count == 0 || isBuying)">
            @if (isBuying)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            }
            Buy Selected (@selectedProductIds.Count)
        </button>
    </div>
</div>

@if (isLoading)
{
    <div class="d-flex justify-content-center align-items-center" style="height:60vh">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading products...</div>
        </div>
    </div>
}
else if (products?.Any() != true)
{
    <div class="alert alert-info">
        All products have sufficient stock! No items needed for shopping.
    </div>
}
else
{
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">@inventoryName</h5>
        </div>
        <div class="card-body">
            <QuickGrid Class="table" Items="products">
                <TemplateColumn Title="" Context="context">
                    <HeaderTemplate>
                        <input type="checkbox" class="form-check-input" @onchange="ToggleSelectAllHeader"
                            checked="@IsAllSelected" />
                    </HeaderTemplate>
                    <ChildContent Context="context">
                        <input type="checkbox" @onchange="(e) => ToggleSelection(e, context)"
                            checked="@selectedProductIds.Contains(context.ProductId)" />
                    </ChildContent>
                </TemplateColumn>
                <PropertyColumn Property="product => product.ProductName" Title="Product" />
                <PropertyColumn Property="product => product.ProductPrice" Title="Price" Format="0.00€" />
                <PropertyColumn Property="product => product.ExistingAmount" Title="Current" />
                <PropertyColumn Property="product => product.DesiredAmount" Title="Needed" />
                <TemplateColumn Title="To Buy">
                    @{
                        var toBuy = Math.Max(0, context.DesiredAmount - context.ExistingAmount);
                    }
                    <span class="badge @(toBuy > 0 ? "bg-danger" : "bg-success")">
                        @toBuy
                    </span>
                </TemplateColumn>
                <TemplateColumn Title="Actions" Context="product">
                    <button class="btn btn-sm btn-success" @onclick="() => BuyOne(product)" disabled="@(product.ExistingAmount >= product.DesiredAmount)">Buy 1</button>
                    <button class="btn btn-sm btn-primary ms-1" @onclick="() => BuyAll(product)" disabled="@(product.ExistingAmount >= product.DesiredAmount)">Buy All</button>
                    <button class="btn btn-sm btn-info ms-1" @onclick="() => ShowBuyCustomDialog(product)">Buy Custom</button>
                </TemplateColumn>
            </QuickGrid>

            <div class="mt-3">
                <strong>Total items to buy:</strong> 
                @{
                    var totalToBuy = products.Sum(p => Math.Max(0, p.DesiredAmount - p.ExistingAmount));
                }
                <span class="badge bg-warning">@totalToBuy</span>
            </div>
        </div>
    </div>

    <dialog @ref="BuyCustomDialog">
        <h4>Buy Custom</h4>
        <div class="mb-3">
            <label for="customAmount" class="form-label">Amount to Buy for @SelectedProduct?.ProductName</label>
            <InputNumber id="customAmount" class="form-control" min="0" step="0.01" @bind-value="CustomAmountToBuy" />
        </div>
        @if (!string.IsNullOrEmpty(buyCustomErrorMessage))
        {
            <div class="alert alert-success">@buyCustomErrorMessage</div>
        }
        <div class="d-flex">
            <button class="btn btn-danger me-2" @onclick="BuyCustomAmount">Buy</button>
            <button class="btn btn-secondary" @onclick="() => jsRuntime.CloseDialog(BuyCustomDialog)">Cancel</button>
        </div>
    </dialog>
}

@code {
    [Parameter]
    public required string inventoryId { get; set; }

    private IQueryable<InventoryProductDto>? products;
    private string inventoryName = "";
    private bool isLoading = true;
    private bool isBuying = false;
    private HashSet<Guid> selectedProductIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        isLoading = true;
        try
        {
            // fetch inventory name for display parity with global shopping list
            try
            {
                var inv = await http.GetFromJsonAsync<Inventory>($"/api/Inventory/{inventoryId}");
                inventoryName = inv?.Name ?? "";
            }
            catch { }

            // Get all products for the inventory
            var allProducts = await
            http.GetFromJsonAsync<IEnumerable<InventoryProductDto>>($"/api/Inventory/{inventoryId}/Products");

            // Filter locally to show only products where desired > existing
            products = allProducts?
            .Where(p => p.DesiredAmount > p.ExistingAmount)
            .OrderByDescending(p => p.DesiredAmount - p.ExistingAmount)
            .AsQueryable();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleSelection(ChangeEventArgs e, InventoryProductDto product)
    {
        var isChecked = false;
        if (e.Value is bool b)
            isChecked = b;
        else if (e.Value is string s && bool.TryParse(s, out var parsed))
            isChecked = parsed;

        if (isChecked)
            selectedProductIds.Add(product.ProductId);
        else
            selectedProductIds.Remove(product.ProductId);
    }

    private bool IsAllSelected => products is not null && selectedProductIds.Count > 0 && products.Count() ==
    selectedProductIds.Count;

    private void ToggleSelectAllHeader(ChangeEventArgs e)
    {
        var isChecked = false;
        if (e.Value is bool b)
            isChecked = b;
        else if (e.Value is string s && bool.TryParse(s, out var parsed))
            isChecked = parsed;

        if (isChecked)
        {
            selectedProductIds.Clear();
            if (products is not null)
            {
                foreach (var p in products)
                    selectedProductIds.Add(p.ProductId);
            }
        }
        else
        {
            selectedProductIds.Clear();
        }
    }

    private async Task BuyAll(InventoryProductDto product)
    {
        isBuying = true;
        try
        {
            var updated = product with { ExistingAmount = product.DesiredAmount };
            var resp = await http.PutAsJsonAsync($"/api/Inventory/{inventoryId}/products/{product.ProductId}", updated);
            if (resp.IsSuccessStatusCode)
            {
                await LoadProducts();
                selectedProductIds.Remove(product.ProductId);
            }
        }
        finally
        {
            isBuying = false;
        }
    }

    private ElementReference BuyCustomDialog;
    private string? buyCustomErrorMessage;
    private InventoryProductDto? SelectedProduct;
    private double CustomAmountToBuy;

    private async Task ShowBuyCustomDialog(InventoryProductDto product)
    {
        buyCustomErrorMessage = null;
        CustomAmountToBuy = 0.0;
        SelectedProduct = product with { };
        await jsRuntime.OpenDialog(BuyCustomDialog);
    }

    private async Task BuyCustomAmount()
    {
        isBuying = true;
        try
        {
            if (string.IsNullOrWhiteSpace(SelectedProduct?.ProductName))
            {
                buyCustomErrorMessage = "Please select a product.";
                return;
            }
            if (CustomAmountToBuy < 0)
            {
                buyCustomErrorMessage = "Amount to buy cannot be negative.";
                return;
            }

            SelectedProduct = SelectedProduct with { ExistingAmount = SelectedProduct.ExistingAmount + CustomAmountToBuy };

            var resp = await http.PutAsJsonAsync($"/api/Inventory/{inventoryId}/products/{SelectedProduct.ProductId}",
            SelectedProduct);
            if (resp.IsSuccessStatusCode)
            {
                await LoadProducts();
                SelectedProduct = null;
                buyCustomErrorMessage = "Product purchased successfully.";
            }
        }
        finally
        {
            isBuying = false;
            await jsRuntime.CloseDialog(BuyCustomDialog);
        }
    }

    private async Task BuyOne(InventoryProductDto product)
    {
        if (product is null)
            return;

        isBuying = true;
        try
        {
            product = product with { ExistingAmount = product.ExistingAmount + 1 };

            var resp = await http.PutAsJsonAsync($"/api/Inventory/{inventoryId}/products/{product.ProductId}", product);
            if (resp.IsSuccessStatusCode)
            {
                await LoadProducts();
                SelectedProduct = null;
            }
        }
        finally
        {
            isBuying = false;
        }
    }

    private async Task BuySelected()
    {
        if (products is null || selectedProductIds.Count == 0)
            return;
        isBuying = true;
        try
        {
            var toBuy = products.Where(p => selectedProductIds.Contains(p.ProductId)).ToList();
            foreach (var product in toBuy)
            {
                var updated = product with { ExistingAmount = product.DesiredAmount };
                await http.PutAsJsonAsync($"/api/Inventory/{inventoryId}/products/{product.ProductId}", updated);
            }
            await LoadProducts();
            selectedProductIds.Clear();
        }
        finally
        {
            isBuying = false;
        }
    }

    private void BackToProducts()
    {
        Navigation.NavigateTo($"/inventory/{inventoryId}/products");
    }
}